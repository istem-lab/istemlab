name: publish
on:
  push:
    branches: [ "main" ]
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.actor }}/istemlab:${{ github.sha }}

jobs:
  publish:
    name: publish image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3

      # Set up Node.js to run ESLint
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Specify your Node.js version

      # Install dependencies (including ESLint)
      - name: Install dependencies
        run: |
          npm ci
          npm install eslint-plugin-next@latest --save-dev  # Ensure ESLint and required plugins are installed

      # Run ESLint to check for issues
      - name: Run ESLint
        run: |
          npx eslint . --ext .js, .jsx, .mjs --max-warnings 0  # This ensures the build fails if any linting warnings are found

      # Docker login and build/push image
      - name: Login
        run: |
          echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and Publish Backend
        run: |
          docker build . --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} || exit 1
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} || exit 1

 